name: Test

on:
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Download pre-built btoon-core (Linux)
        if: runner.os == 'Linux'
        env:
          CORE_VERSION: v0.0.1
        run: |
          echo "Downloading pre-built btoon-core ${CORE_VERSION} for Linux..."
          wget -q https://github.com/BTOON-project/btoon-core/releases/download/${CORE_VERSION}/btoon-${CORE_VERSION}-linux-x64.tar.gz
          echo "Extracting to core/build/..."
          mkdir -p core/build
          tar xzf btoon-${CORE_VERSION}-linux-x64.tar.gz -C core/build --strip-components=1
          ls -la core/build/

      - name: Download pre-built btoon-core (macOS)
        if: runner.os == 'macOS'
        env:
          CORE_VERSION: v0.0.1
        run: |
          echo "Downloading pre-built btoon-core ${CORE_VERSION} for macOS..."
          if [ "$(uname -m)" = "arm64" ]; then
            ARCH="arm64"
          else
            ARCH="x64"
          fi
          wget -q https://github.com/BTOON-project/btoon-core/releases/download/${CORE_VERSION}/btoon-${CORE_VERSION}-darwin-${ARCH}.tar.gz
          echo "Extracting to core/build/..."
          mkdir -p core/build
          tar xzf btoon-${CORE_VERSION}-darwin-${ARCH}.tar.gz -C core/build --strip-components=1
          ls -la core/build/

      - name: Download pre-built btoon-core (Windows)
        if: runner.os == 'Windows'
        env:
          CORE_VERSION: v0.0.1
        shell: bash
        run: |
          echo "Downloading pre-built btoon-core ${CORE_VERSION} for Windows..."
          curl -L -o btoon-windows.zip https://github.com/BTOON-project/btoon-core/releases/download/${CORE_VERSION}/btoon-${CORE_VERSION}-windows-x64.zip
          echo "Extracting to core/build/..."
          mkdir -p core/build/Release
          unzip -q btoon-windows.zip -d core/build-temp
          cp -r core/build-temp/btoon-${CORE_VERSION}-windows-x64/* core/build/Release/
          ls -la core/build/Release/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Copy headers to expected location
        shell: bash
        run: |
          echo "Copying headers from submodule to build directory..."
          mkdir -p core/build/include
          cp -r core/include/* core/build/include/ 2>/dev/null || cp -r core/include/* core/build/Release/ 2>/dev/null || true
          ls -la core/build/

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest build wheel pybind11

      - name: Build and install package
        run: |
          pip install -e .

      - name: Run quick test
        run: python test_quick.py

      - name: Run comprehensive tests
        run: pytest test_comprehensive.py -v

      - name: Test basic functionality
        run: |
          python -c "import btoon; print(f'Version: {btoon.version()}')"
          python -c "import btoon; data = {'test': True}; assert btoon.decode(btoon.encode(data)) == data; print('âœ… Basic test passed')"
